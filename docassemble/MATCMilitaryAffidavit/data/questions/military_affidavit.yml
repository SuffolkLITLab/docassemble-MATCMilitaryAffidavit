---
include:
  - docassemble.AssemblyLine:assembly_line.yml
  - docassemble.ALMassachusetts:al_massachusetts.yml
  - docassemble.MassAccess:massaccess.yml
  - military_affidavit.yml
  - docassemble.MATCTheme:matc_theme.yml
---
metadata:
  title: |
    Military Affidavit
  short title: |
    Military Affidavit
  authors:
    - Pratibha Bharti
    - Quinten Steenhuis
    - Conner McGarry
    - Maeve Torrey
---
code: |
 military_affidavit_proof_attachment.enabled=has_used_scra_site and wants_to_attach_search_results
---
code: |
  interview_metadata['main_interview_key'] =  'military_affidavit'
---
code: |
  addresses_to_search = [users[0].address]
---
code: |
  # This controls the default country and list of states in address field questions
  AL_DEFAULT_COUNTRY = "US"
---
code: |
  # This controls the default state in address field questions
  AL_DEFAULT_STATE = "MA"
---
code: |
  github_repo_name =  'docassemble-MilitaryAffidavit'
---
code: |
  interview_short_title = "Tell the court whether any of the people in your case have served in the military"
---
code: |
  al_form_type = "existing_case" 
---
objects:
  - other_parties: ALPeopleList
  - serving_parties: ALPeopleList
  - unsure_serving_parties: ALPeopleList.using(auto_gather=False, gathered=True)
  - concluded_service_parties: ALPeopleList.using(auto_gather=False, gathered=True)
  - military_affidavit_attachment: ALDocument.using(title="Military Affidavit", filename="military_affidavit", has_addendum=False)
  - military_affidavitr_10_attachment: ALDocument.using(title="Military Affidavit R10", filename="military_affidavitr_10", has_addendum=False)
  - military_affidavit_proof_attachment: ALDocumentUpload.using(
          title="Military Affidavit Proof",
          filename="Military Affidavit Proof", 
          has_addendum=False
        )
  - military_affidavit_next_steps: ALDocument.using(title="Next steps & filing instructions", filename="military_affidavit_next_steps", has_addendum=False, enabled=True)
  - al_user_bundle: ALDocumentBundle.using(elements=[military_affidavit_attachment,military_affidavit_next_steps, military_affidavit_proof_attachment], filename="military_affidavit", title="All forms to download for your records", enabled=True)
  - al_court_bundle: ALDocumentBundle.using(elements=[military_affidavit_attachment, military_affidavit_proof_attachment], filename="military_affidavit", title="All forms to deliver to court", enabled=True)
---
sections:
  - review_military_affidavit: Review your answers
---
mandatory: True
comment: |
  Global interview metadata
variable name: interview_metadata["military_affidavit"]
data:
  al_weaver_version: "1.8.0"
  generated on: "2023-02-28"
  title: >-
    Military Affidavit
  short title: >-
    Military Affidavit
  description: |-
    Affidavit Declaring whether the party is a military servicemember
  allowed courts: 
    - "Boston Municipal Court"
    - "District Court"
    - "Housing Court"
    - "Juvenile Court"
    - "Land Court"
    - "Probate and Family Court"
    - "Superior Court"
  categories:
    - "ED-00-00-00-00"
    - "MO-00-00-00-00"
    - "HE-00-00-00-00"
    - "IM-00-00-00-00"
    - "BE-00-00-00-00"
    - "FA-07-00-00-00"
    - "HO-00-00-00-00"
    - "BE-04-00-00-00"
    - "ES-00-00-00-00"
    - "RI-10-00-00-00"
    - "FA-00-00-00-00"
  typical role: "unknown"
  generate download screen: True
---
code: |
  interview_metadata['main_interview_key'] =  'military_affidavit'
---
###################### Main order ######################
comment: |
  This block includes the logic for standalone interviews.
  Delete mandatory: True to include in another interview
mandatory: True
code: |
  # military_affidavit_intro
  nav.set_section("review_military_affidavit")
  interview_order_military_affidavit
  signature_date
  # Store anonymous data for analytics / statistics
  store_variables_snapshot(
      persistent=True,
      data={
          "zip": showifdef("users[0].address.zip"),
          "reached_interview_end": True,
      },
  )
  military_affidavit_download
---
#################### Interview order #####################
comment: |
  Controls order and branching logic for questions specific to this form
id: interview_order_military_affidavit
mandatory: True
code: |
  al_intro_screen
  military_affidavit_intro
  user_role
  if user_role == "attorney":
   attorneys.there_are_any = True
   bbo
  is_there_helper
  if is_there_helper:
    helper_attorney
  docket_number
  users.gather()
  other_parties.gather()
  #if dont_know_docket_number:
    #summary_process_check
  trial_court
  set_all_military_statuses
  if any([party.military_status == "past" for party in other_parties]):
    set_concluded_service_dates
  if any([party.military_status == "unknown" for party in other_parties]):
    bond_agreement_i_understand
  #review_military_status
  #if summary_process_check:
    #set_vacated_status
    #vacated_parties
    #monthly_rent
    #set_unpaid_rent_month_year
    #rent_worksheet
    #months_unpaid_total
    #uniform_seen 
  in_service
  #if summary_process_check == False:
  has_used_scra_site
  used_scra_site_facts
  not_used_scra_site_facts
  signature_date
  users[0].signature
  #military_affidavit_case_name
  interview_order_military_affidavit = True
---
code: |
  concluded_service_parties[i].name.first
  concluded_service_parties[i].service_ended_date
  concluded_service_parties[i].complete = True
---
template: proof_of_status
subject: |
  What counts as proof of military status?
content: |
  You can demonstrate military status through the following:
  
  - SCRA website search: Use the official search portal and attach the result (PDF or screenshot).
  
  - A statement of your own knowledge: For example, the person works in civillian employment, or has shared their status with you. Here a simple clear statement on this form is sufficient. 

---
id: Military_Affidavit
continue button field: military_affidavit_intro
question: |
  Military Affidavit
subquestion: |
  This interview will help you fill out a Military Affidavit,
  which declares whether anybody who is part of this case is
  currently serving in a branch of the U.S. military.

  If someone is in the military, they may have special
  protections under the Servicemembers Civil Relief Act.

  This affidavit has to be filed even if none of the parties are
  in the military right now.
    
  You will be required to tell the court how you know by providing proof of the defendant's military status. If you do not have this knowledge you cannot complete the military affiadvit.

  You have two options:
 
  1. Use the SCRA Website — If you know the defendant’s date of birth or Social Security number, you can search their military status [here](https://scra.dmdc.osd.mil/scra/#/home). The website will create a certificate you must send to the court.

    2. If you didn’t use the SCRA Website, explain how else you found out the defendant’s military status. For example, you may have spoken to the defendant, or contacted a branch of the military listed [here](https://www.defense.gov/Resources/Military-Departments/).
  
  
  ${ collapse_template(proof_of_status) }
---
id: User Type
question: |
  Who is filling out this form?
fields:
  - "I am": user_role
    datatype: radio
    choices:
      - Representing myself: user
      - An attorney: attorney
  - BBO number: bbo
    maxlength: 10
    datatype: number
    show if:
      variable: user_role
      is: "attorney"
---
sets:
  - other_parties[i].name.first
  - other_parties[i].name.last
  - other_parties[i].name.middle
  - other_parties[i].name.suffix
id: names of opposing parties
question: |
  % if user_started_case:
  Name of ${ ordinal(i) } defendant, respondent, or interested party in this
  matter
  % else:
  Name of ${ ordinal(i) } plaintiff or petitioner in this matter
  % endif
fields:
  - code: |
      other_parties[i].name_fields(person_or_business='person')
---
id: any other opposing parties
question: |
  % if user_started_case:
  Is there any other defendant, respondent, or interested party in this
  matter?
  % else:
  Is there any other plaintiff or petitioner in this matter?
  % endif
fields:
  - no label: other_parties.there_is_another
    datatype: yesnoradio
---
code: |
  other_parties.there_are_any = len(other_parties) > 0

---
code: |
  other_parties.there_are_any = True
  if len(other_parties) == 0:
      other_parties.appendObject()
---
id: any other users
question: |
  % if al_form_type in ['starts_case','existing_case','appeal']:
  Are there any other petitioners or plaintiffs in this case?
  % else:
  Is anyone else adding their name to this form with you?
  % endif
subquestion: |
  % if len(users.elements) > 1:  
  So far you have told us about ${comma_and_list(users.complete_elements())}.
  % endif
fields:
  - no label: users.there_is_another
    datatype: yesnoradio
---
template: explain_docket_number
subject: What is a docket number?
content: |
  The docket number is a unique identifier that the court assigns to your case.

  A Massachusetts Trial Court docket number will look something like this:

  15H84CV000436 or 1401CV001026

  The docket number is made of of these parts:
  Two Digit Year > Two Digit Court Code > Two Letter Case Type > Six Digit Sequence Number

---
id: docket number
question: |
  What is the docket number for your case?
subquestion: |
  ${ collapse_template(explain_docket_number)}
fields:
  - I don't know the docket number: dont_know_docket_number
    datatype: yesno    
  - Docket number: docket_number
    hide if: dont_know_docket_number
validation code: |
  # This should be safe to 
  if dont_know_docket_number:
    docket_number = ''      
---
id: is_there_helper
question: |
  Are you receiving help from an attorney to complete this form?
fields:
  - "": is_there_helper
    datatype: yesnoradio
---
id: helper_attorney
question: |
  Please enter the attorney's information.
fields:
  - "Attorney's name": helper_attorney
  - "Attorney's BBO number (if known)": helper_bbo
---
template: fee_waiver_docket_number_explanation_template
subject: |
  What's a docket number?
content: |
  The docket number is a number that the court assigns to track your case.
  
  If this is a new case, you may not have one yet. You can tell the
  clerk what you know about the case if you're not sure.
---
id: explanation diligent search
question: |
  Before you answer the next questions
subquestion: |
  On the next few screens, we will ask you about the military status 
  of:

  * ${ users }
  % if len(other_parties):
  * ${ other_parties }
  % endif
fields:
  - Do you already know the military status of each party in this case?: knows_status_already
    datatype: yesnoradio
  - note: |
      If you do not have personal knowledge of each party's military status,
      you must search the [Servicemembers Civil Relief Act website](https://scra.dmdc.osd.mil/).

      1. Copy a [link to this interview](${ interview_url() }) to return to it later. You can also 
         leave this window or tab open.
      1. Click the link to visit the [Servicemembers Civil Relief Act website](https://scra.dmdc.osd.mil/)
         and search for the name of the party who you are unsure about.
      1. Save a copy of the results as a PDF or take a screenshot that shows the search
         results. You can also print a copy and attach it to this form later.

        You can take a minute to do that now. The website will open in a new tab. When
        you have finished your search and saved the results, close the tab to return to this interview.
    show if: 
      variable: knows_status_already
      is: False
---
variable name: military_status_labels
data:
  - Yes: "yes"
  - No: "no"
  - Past: "past"
  - Unknown: "unknown"
---
continue button field: set_all_military_statuses
id: select all statuses
question: |
  Select the current military service for each person presented
subquestion: |
  For each defendant:

  * If they are currently serving active duty in the military, answer "Yes".
  * If they are not serving in the military, answer "No"
  * If they concluded their service, answer "Past"
  * If you are unsure, answer "Unknown"

  ${ collapse_template(explain_military_service)}
fields:
  - code: |
      [
        {
          "field": party.attr_name("military_status"),
          "label": f"{ party.name_full() }",
          "item grid": {
            "width": 3,
            "breakpoint": "sm"
          },
          "datatype": "radio",
          "choices": military_status_labels
        }
        for party in sorted(other_parties)
      ]
---
template: explain_military_service
subject: |
  What is military service?
content: |
  For the purposes of this form, "military service" includes the following:

  1. Members of the armed forces on active duty.

  This refers to individuals serving full time in the Army, Navy, Air Force, Marine Corps, or Coast Guard, including those in the Reserves and National Guard when called to active duty.
  
  2. Members of the National Guard on service under a call to active service for more than 30 consecutive days.

  This includes National Guard members who are called to active duty by the President or the Secretary of Defense for emergencies, wars, or other national defense needs.

  3. Commissioned officers of the Public Health Service or the National Oceanic and Atmospheric Administration (NOAA) on active service.

  These commissioned officers are also considered to be in "military service" when performing their duties.

  Someone who is otherwise in active service but is currently absent because of sickness, injury, leave, or other lawful cause is still considered to be in active military service.
---
id: set all concluded service parties dates
question: |
  When did the military service end?
subquestion: |
  Write the best date that you know for each party. Include a year.  Example: May 2024.
fields:
  - code: |
      [
        {
          "field": party.attr_name("service_ended_date"),
          "label": party.name_full(),
          "under text": "Date service ended"
        }
        for party
        in
        sorted(other_parties)          
        if party.military_status == "past"
      ]
continue button field: set_concluded_service_dates
---
#id: monthly rent amount
#question: |
# What was the monthly rent amount?
#subquestion: |
#    Please enter the dollar amount that was due each month for rent.  
#    You will have a chance to adjust this amount for individual months #later if needed. 
#fields:
#  - "Monthly rent amount:": monthly_rent
#    datatype: currency
---
#id: rent_unpaid_month_year_prep
#code: |
#  import calendar
#  from datetime import date
#  months_choices = [
#    {"label": calendar.month_name[m], "value": m}
#    for m in range(1, 13)
#  ]
#  this_year = date.today().year
#  years_choices = [
#    {"label": str(y), "value": y}
#    for y in range(this_year - 5, this_year + 1)
#  ]
---
#id: rent_unpaid_month_year
#question: |
#   After filing the lawsuit, when did the unpaid rent period begin and #end?
#  Please enter the first and last month and year that rent went unpaid #after you filed the lawsuit.
#fields:
#  - code: |
#        {
#          "field": "unpaid_start_month",
#          "label": "First month",
#          "datatype": "select",
#       {
#          "field": "unpaid_start_year",
#         "choices": years_choices
#        },
#        {
#         "datatype": "select",
#          "choices": months_choices
#        },
#        {
#          "field": "unpaid_end_year",
#          "label": "Year",
#          "datatype": "select",
#          "choices": years_choices
#        }
#      ]
#continue button field: set_unpaid_rent_month_year
---
#code: |
#  from datetime import date
#  # Cast the dropdown strings to ints (day=1)
#  start = date(int(unpaid_start_year), int(unpaid_start_month), 1)
#  end   = date(int(unpaid_end_year),   int(unpaid_end_month),   1)
#  # Store the first month and year combo as a label
#  first_month_year = start.strftime("%B %Y")
#  months_to_calc = []
#  current = start
#  while current <= end:
#      key = current.strftime("%Y_%m")
#      label = current.strftime("%B %Y")
#      months_to_calc.append((key, label))
#      # Advance one month
#      if current.month == 12:
#          current = current.replace(year=current.year+1, month=1)
#      else:
#          current = current.replace(month=current.month+1)
#continue button field: set_months_to_calc
---
#id: rent_worksheet
#question: |
#  For each month listed below, please:
#subquestion: |
#  1. Verify the month name heading.  
#  2. Review the prefilled Rent Due amount.  
#  3. Enter the actual amount Paid in the Rent Paid box.
#fields:
#  - code: |
#      sum([
#        [
#          {"note": f"**{label}**", "item grid": {"width": 12, #"breakpoint": "sm"}},
#          {
#            "field": f"rent_due_{key}",
#            "label": "Rent due",
#            "datatype": "currency",
#            "default": monthly_rent,
#            "item grid": {"width": 6, "breakpoint": "sm"}
#          },
#          {
#            "field": f"rent_paid_{key}",
#            "label": "Rent paid",
#            "datatype": "currency",
#            "item grid": {"width": 6, "breakpoint": "sm"}
#          }
#        ]
#        for key, label in months_to_calc
#      ], [])
#continue button field: rent_worksheet
---
#id: calculate_monthly_unpaid_and_paid
#code: |
#  # initialize running totals
#  months_unpaid_total = 0
#  months_paid_total = 0
#
#  for i, (key, label) in enumerate(months_to_calc):
#      # look up amount paid this month (defaults to 0)
#      paid = locals().get(f"rent_paid_{key}", 0) or 0
#      # calculate what’s still owed
#      unpaid = monthly_rent - paid
#
#      # dynamically set month1, month1_paid, month1_unpaid, month2, #month2_paid, ...
#      vars()[f"month{i+1}"] = label
#      vars()[f"month{i+1}_paid"] = paid
#      vars()[f"month{i+1}_unpaid"] = unpaid
#
#      # add to grand totals
#      months_paid_total += paid
#      months_unpaid_total += unpaid
#
#  # expose the grand totals
#  vars()["months_unpaid_total"] = months_unpaid_total
#  vars()["months_paid_total"] = months_paid_total
---
#id: R10 facts supporting knowledge of service 
#question: |
#  Do you have any facts that show the defendant's military service status?
#subquestion: |
#  Please check all that apply:
#fields:
#  - "I saw the defendant in a military uniform.": uniform_seen
#    datatype: yesno
#  - "The defendant works in civilian employment.": civillian_seen
#    datatype: yesno
#  - "The defendant has acknowledged their military status.": #defendant_acknowledge
#    datatype: yesno
#  - "I have other facts or reasons that show the defendant(s) military #status.": other_facts
#    datatype: yesno
#  - "Please describe the other facts here:": other_facts_text
#    maxlength: 120
#    show if: other_facts
---
code: |
  # Assume we're only checking one defendant at a time (can be adjusted for lists)
  for party in other_parties:
      if uniform_seen:
          party.military_status = "Active Duty"
      elif civillian_seen or defendant_acknowledge:
          party.military_status = "Not Active Duty"
      elif other_facts and other_facts_text.strip() != "":
          party.military_status = "Unknown"
      else:
          party.military_status = "Unknown"

---
id: unsure military service
question: |
  Because you are unsure about the military status of some parties
subquestion: |
  If you select "unsure" for any party, the judge may make you pay
  a bond to protect the party's rights under the Servicemembers Civil Relief Act,
  before the judge makes the judgment against the party final.

  ${ collapse_template(explain_military_unsure_bond) }
fields:
  - I understand I may have to pay a bond if I am unsure about a party's military status before a judge makes the judgment final: bond_agreement_i_understand
    datatype: yesno
validation code: |
  if not bond_agreement_i_understand:
    validation_error("You must acknowledge that the judge can make you a bond if you are unsure about a party's military status.", field="bond_agreement_i_understand")
---
template: explain_military_unsure_bond
subject: |
  What is the bond for?
content: |
  If you are unsure about the military status of any party in this case, the judge may require you to pay a bond to protect the party's rights under the Servicemembers Civil Relief Act.

  The bond is money that you pay to the court. If the party is in the military, the bond will protect their rights under the Servicemembers Civil Relief Act. 
  If the party is not in the military, the bond will be returned to you.

  The bond is only required if the other party does not show up in court
  and loses "by default".
---
sets: 
  - in_service
  - unable_service
  - not_service
  - past_service_checkbox
code: |

  # split them out by status
  serving_list = [p.name_full() for p in other_parties if p.military_status == 'yes']
  past_list    = [p.name_full() for p in other_parties if p.military_status == 'past']
  unsure_list  = [p.name_full() for p in other_parties if p.military_status == 'unknown']
  no_list      = [p.name_full() for p in other_parties if p.military_status == 'no']

  # now expose both the raw lists (joined as comma‐strings) and booleans
  from docassemble.base.util import comma_and_list
  serving_parties_text        = comma_and_list(serving_list)
  past_service_text           = comma_and_list(past_list)
  unsure_serving_parties_text = comma_and_list(unsure_list)
  not_serving_parties_text    = comma_and_list(no_list)

  in_service     = bool(serving_list)
  not_service    = bool(no_list)
  past_service_checkbox = bool(past_list)
  unable_service = bool(unsure_list)

---
#id: confirm serving party status
#question: |
#  Confirm the military status of each party
#subquestion: |
#  Here is what you told us about each party:
#
#  ${ all_party_status_review_table }
#
#  ${ action_button_html(url_action('set_all_military_statuses'), #label="Edit military service status")}
#continue button field: review_military_status
---
#table: all_party_status_review_table
#rows: other_parties + additional_parties
#columns:
#  - Name: |
#      row_item.name_full()
  # Find the first matching key in the military_status_labels list and show the matching text - this is for translation
#  - In active service?: |
#      next((k for d in military_status_labels for k, v in d.items() if v #== row_item.military_status), "")
---
#id: vacated status question 
#question: |
#  Have any of the tenants moved out of the property?
#
#  "Vacated" means the tenant has permanently left the property and no #longer lives there. 
#fields:
#  - "Has at least one tenant permanently moved out?": vacated_status
#    datatype: yesnoradio
---
sets:
  - summary_process_check
code: |
  # Default
  summary_process_check = False

  # Safely handle None or empty docket numbers
  dn = docket_number or ''

  # Need at least 7 chars to include year, court code, and case‑type
  if len(dn) >= 7:
      # 1) Housing Court: 3rd char "H", next two chars digits, then "SP"
      if dn[2] == 'H' and dn[3:5].isdigit() and dn[5:7] == 'SP':
          summary_process_check = True
      # 2) District/BMC: 3rd char ≠ "H", first two‑digit court code, then "SU"
      elif dn[2] != 'H' and dn[2:4].isdigit() and dn[4:6] == 'SU':
          summary_process_check = True
---
id: summary_process_check
question: |
  Is this a Summary Process Case?
subquestion: |
  ${collapse_template(sumpro_ex)}  
fields:
  - "Select no for any other case type": summary_process_check
    datatype: yesnoradio
---
template: sumpro_ex
subject: |
  What is a Summary Process Case?
content: |
  In Massachusetts, an eviction case is legally called a "Summary Process" case. These are typically filed in Housing Court when a landlord is seeking to remove a tenant from a rental property. Common causes of summary process cases include: Tenant not paying rent, tenant breaking the lease, tenant not leaving after the lease ends and the tenant not leaving after proper notice.
  If your goal is to remove someone from a rental unit, it is likely a summary process case.
---
id: set_vacated_status
question: |
  Tell us whether each defendant has vacated the premises:
fields:
  - code: |
      [
        {
          "field": party.attr_name("vacated"),
          "label": party.name_full(),
          "item grid": {
            "width": 6,
            "breakpoint": "sm"
          },
          "datatype": "radio",
          "choices": [
            {"label": "Vacated", "value": True},
            {"label": "Still living there", "value": False}
          ],
        }
        for party in sorted(other_parties)
      ]
  - Select the date the defendant vacated the property: vacated_date
    datatype: ThreePartsDate
    js show if: |
      val("other_parties[0].vacated") || val("other_parties[1].vacated") || val("other_parties[2].vacated") || val("other_parties[3].vacated") || val("other_parties[4].vacated") || val("other_parties[5].vacated")
continue button field: set_vacated_status
---
code: |
  vacated_parties = [party.name_full() for party in other_parties if getattr(party, "vacated", None) is True]
  parties_vacated = len(vacated_parties) > 0
  premise_occupy = any(getattr(party, "vacated", None) is False for party in other_parties)
---
id: your name
sets:
    - users[0].name.first
    - users[0].name.last
    - users[0].name.middle
    - users[0].name.suffix
question:  |
  % if user_role == "attorney":
  What is your client's name?
  % else:
  What is your name?
  % endif
subquestion: |
  If this case is "in the interests of" someone else, enter their name here.

  For example, if this case is for a guardianship or conservatorship, enter
  the name of the person who needs the guardian or conservator.
fields:
  - code: |
      users[0].name_fields()
---
#id: has additional parties
#question: |
#  Is there someone else with an interest in this case?
#subquestion: |
#  For example, if this is a guardianship or conservatorship case, you may have to list the
#  parents or other relatives of the person who needs a guardian as well
#  as your own name.
#fields:
#  - There is someone else with an interest in this case: additional_parties.there_are_any
#    datatype: yesnoradio
#  - note: |
#      We will call this person an additional party in the rest of this interview.
#    show if: additional_parties.there_are_any
---
---
#event: review_vacated_status
#question: |
#  Review vacated status information
#review:
 # - Edit: set_vacated_status
  #  button: |
  #    Tenant status
#
#      % for party in other_parties:
#      * **${ party.name_full() }**:  
#        % if defined("party.vacated"):
#        ${ "Vacated" if party.vacated else "Still living there" }
#        % else:
#        Not answered
#        % endif
#      % endfor
#  - Edit: vacated_date
#    button: |
#      Date tenant moved out  
#      ${ vacated_date }
---
#id: additional party name 
#sets:
#  - additional_parties[i].name.first
#  - additional_parties[i].name.last
#  - additional_parties[i].name.middle
#  - additional_parties[i].name.suffix
#question: |
#  What is the name of the ${ ordinal(i ) } additional party in this case?
#subquestion: |
#  % if len(additional_parties.complete_elements()) >= 1:
#  You have already told us about ${ additional_parties.complete_elements() }.
#  % endif
#fields:
#  - code: |
#      additional_parties[i].name_fields()
---
code: |
  serving_parties = DAList()
  concluded_service_parties = DAList()
  unsure_serving_parties = DAList()

  for party in users + other_parties:
      if hasattr(party, 'military_status'):
          if party.military_status == "Active Duty":
              serving_parties.append(party)
          elif party.military_status == "Not Active Duty":
              concluded_service_parties.append(party)
          elif party.military_status == "Unknown":
              unsure_serving_parties.append(party)

---
id: supporting the affidavit
question: |
  How do you know the military status of the parties in this case?
subquestion: |
    You will be required to provide proof of how you know the defendant's military status later in this interview. 
    
    You have two options:

    1. Use the SCRA Website — If you know the defendant’s date of birth or Social Security number, you can search their military status [here](https://scra.dmdc.osd.mil/scra/#/home). The website will create a certificate you must send to the court.

    2. Use another method — If you didn’t use the SCRA Website, explain how else you found out the defendant’s military status. For example, you may have spoken to the defendant, or contacted a branch of the military listed [here](https://www.defense.gov/Resources/Military-Departments/).

fields:
  - "Did you use the Servicemembers Civil Relief Act Website?": has_used_scra_site
    datatype: yesnoradio

---  
id: Used SCRA
question: Because you used the SCRA Webstite...
fields:
  - Attach a copy of the search results if you have them: military_affidavit_proof_attachment.file
    datatype: file
    required: False
    file css class: None
    accept: |
      ".pdf, .png, application/pdf, image/*"
  - "Explain how you used the website in your search (optional if evidence attached)": used_scra_site_facts
    required: False
    input type: area
---
id: not Used SCRA
question: Because you did not use the SCRA Website...
fields:
  - Explain how you know: not_used_scra_site_facts
    input type: area
    required: False
    help: |
      For example: I know the party personally.
---
code: |
  signature_fields = ['users[0].signature']

---
id: military affidavit review screen
# event: review_military_affidavit
question: |
  Review your answers
review:
  - Edit: trial_court
    button: |
      Trial court  
      % if defined("trial_court.department"):
      * department: ${ trial_court.department }
      % endif
      % if defined("trial_court.division"):
      * division: ${ trial_court.division }
      % endif
  - Edit: users.revisit
    button: |
      People on your side of the case

      % for item in users:
        * ${ item }
      % endfor
  - Edit: other_parties.revisit
    button: |
      People on the other side of the case

      % for item in other_parties:
        * ${ item }
      % endfor
  - Edit: exhibit_attachment.exhibits.has_exhibits
    button: |
      Is the attachment included?

      % if exhibit_attachment.exhibits.has_exhibits:
      Yes
      % elif not exhibit_attachment.exhibits.has_exhibits:
      No
      % endif   
  - note: |
      Supporting exhibits:
      
      % if exhibit_attachment.exhibits.there_are_any:
      ${ exhibit_attachment.exhibits.in_progress_exhibits }
      % else:
      You have not attached any exhibits yet.
      % endif

      ${ exhibit_attachment.exhibits.add_action() }
    css class: bg-secondary-subtle
    show if: exhibit_attachment.exhibits.has_exhibits
  - Edit: docket_number.revisit
    button: |
      Docket numbers

      % for item in docket_number:
        * ${ item }
      % endfor
  - note: |
      Military status of parties

      Here is what you told us:

      % if len(serving_parties):
      % if len(serving_parties) == 1:
      * You know that ${ serving_parties } is currently serving in the military.
      % else:
      * You know that ${ serving_parties } are currently serving in the military.
      % endif
      % endif
      % if len(concluded_service_parties):
      * You know that ${ concluded_service_parties } served in the military in the past.
      % endif
      % if len(unsure_serving_parties):
      * You do not know whether ${ unsure_serving_parties } served in the military.
      % endif

      % if len(( users.union(other_parties).difference(serving_parties + concluded_service_parties + unsure_serving_parties))):
      That means that you know the following parties are not serving in the military:

      * ${ comma_and_list( users.union(other_parties).difference(serving_parties + concluded_service_parties + unsure_serving_parties)) }
      % endif

      If this is not correct, edit your responses by clicking the button below.

      * ${ action_button_html(url_action('serving_parties'), label="Edit parties currently serving in the military")}
      * ${ action_button_html(url_action('concluded_service_parties'), label="Edit parties whose service ended")}
      * ${ action_button_html(url_action('unsure_serving_parties'), label="Edit parties you do not know about")}

  - Edit: signature_date
    button: |
      Date of signature:
      ${ signature_date }
  - Edit: bbo
    button: |
      BBO number (if you are an attorney):
      ${ bbo }
---
id: revisit exhibit_attachment
continue button field: exhibit_attachment.revisit
question: |
  Edit your supporting attachment
subquestion: |
  ${ exhibit_attachment.exhibits.rearrange_exhibits_table }

  ${ exhibit_attachment.add_action() }
---
continue button field: plaintiffs.revisit
question: |
  Edit plaintiffs
subquestion: |
  ${ plaintiffs.table }

  ${ plaintiffs.add_action() }
---
table: plaintiffs.table
rows: plaintiffs
columns:
  - Name: |
      row_item.name.full() if defined("row_item.name.first") else ""
edit:
  - name.first
confirm: True

---
continue button field: defendants.revisit
question: |
  Edit defendants
subquestion: |
  ${ defendants.table }

  ${ defendants.add_action() }
---
table: defendants.table
rows: defendants
columns:
  - Name: |
      row_item.name.full() if defined("row_item.name.first") else ""
edit:
  - name.first
confirm: True
---
continue button field: docket_number.revisit
question: |
  Edit docket_number
subquestion: |
  ${ docket_number.table }

  ${ docket_number.add_action() }
---
table: docket_number.table
rows: docket_number
columns:
  - Name: |
      row_item
edit: True
confirm: True

---
continue button field: users.revisit
question: |
  Edit users
subquestion: |
  ${ users.table }

  ${ users.add_action() }
---
table: users.table
rows: users
columns:
  - Name: |
      row_item.name.full() if defined("row_item.name.first") else ""
  - Signature: |
      row_item.signature if defined("row_item.signature") else ""
edit:
  - name.first
  - signature
confirm: True

---
# ALDocument objects specify the metadata for each template
objects:
  - military_affidavit_attachment: ALDocument.using(title="Military Affidavit", filename="military_affidavit", has_addendum=False, )
  - military_affidavit_search_results: ALDocumentUpload.using(title="Search results from SCRA website", filename="military_affidavit_search_results", has_addendum=False, )
---
objects:
  - military_affidavit_bundle: ALDocumentBundle.using(elements=[military_affidavit_attachment, military_affidavit_search_results], filename="military_affidavit", title="Military Affidavit", enabled=True)
---
code: |
  military_affidavit_search_results.enabled = has_used_scra_site and wants_to_attach_search_results
---
code: |
  military_affidavit_attachment.enabled = True
---
code: |
  # This is available to customize in other forms with more complex case name scenarios
  # Leave it undefined to use the default case name of petitioner v respondent or In the interests of respondent
  military_affidavit_case_name = ""
---
#code: |
#  if summary_process_check:
#      military_affidavitr_10_attachment.enabled = True
#      military_affidavit_attachment.enabled = False
#      military_affidavit_proof_attachment.enabled = False
#
#  else:
#      military_affidavitr_10_attachment.enabled = False
#      military_affidavit_attachment.enabled = True

---
attachment:
  name: Next steps & filing instructions
  filename: military_affidavit_next_steps
  variable name: military_affidavit_next_steps[i]
  skip undefined: True
  docx template file: military_affidavit_next_steps.docx
---
#attachment:
#  name: military affidavit rule 10
#  filename: military_affidavit rule 10
#  variable name: military_affidavitr_10_attachment[i]
#  skip undefined: True
#  pdf template file: military_affidavitr_10.pdf
#  enabled: False
#  fields:
#      - "docket_number__1": ${ docket_number }
#      - "docket_number__2": ${ docket_number }
#      - "trial_court_division__1": ${ trial_court.division }
#      - "trial_court_division__2": ${ trial_court.division }
#      - "petitioners": |
#          % if showifdef("military_affidavit_case_name"):
###           % if user_ask_role == "plaintiff":
#            % if len(other_parties):
#          ${ users }
#            % else:
#          In the interests of ${ users }
#            % endif
#            % else:
#          ${ other_parties }
#            % endif
#          % endif
#      - "respondents": |
#          % if user_ask_role == "defendant":
#          ${ users }
#          % else:
#          ${ other_parties.short_list(limit=2) }
#          % endif
#      - "users1_name_full__1": ${ users[0] }
#      - "not_service": ${ not_service }
#      - "in_service": ${ in_service }
#      - "serving_parties": ${ serving_parties }
#      - "unable_service": ${ unable_service }
#      - "unsure_serving_parties": ${ unsure_serving_parties }
#      - "uniform_seen": ${ uniform_seen }
#      - "civillian_seen": ${ civillian_seen }
#      - "defendant_acknowledge": ${ defendant_acknowledge }
#      - "other_facts": ${ other_facts }
#      - "other_facts_text": ${ other_facts_text }
#      - "unpaid_rent": ${ months_unpaid_total }
#      - "unpaid_rent_date": ${ first_month_year }
#      - "premise_occupy": ${ premise_occupy }
#      - "vacated_date": ${ vacated_date.format() }
#      - "parties_vacated": ${ parties_vacated }
#      - "vacated_parties": ${ comma_and_list(vacated_parties) }
#      - "bbo_number": ${ bbo_number }
#      - "users1_full_name__2": ${ users[0].name.full() }
#      - "signature_date": ${ signature_date }
#      - "users1_signature": ${ users[0].signature_if_final(i) }
#      - "month1_unpaid": ${ month1_unpaid }
#      - "month1": ${ month1 }
#      - "month2_unpaid": ${ month2_unpaid }
#      - "month2": ${ month2 }
#      - "month3_unpaid": ${ month3_unpaid }
#      - "month3": ${ month3 }
#      - "month4_unpaid": ${ month4_unpaid }
#      - "month4": ${ month4 }
#      - "month5_unpaid": ${ month5_unpaid }
#      - "month5": ${ month5 }
#      - "month6_unpaid": ${ month6_unpaid }
#      - "month6": ${ month6 }
#      - "month7": ${ month7 }
#      - "month7_unpaid": ${ month7_unpaid }
#      - "month8": ${ month8 }
#      - "month8_unpaid": ${ month8_unpaid }
#      - "month9": ${ month9 }
#      - "month9_unpaid": ${ month9_unpaid }
#      - "month10": ${ month10 }
#      - "month10_unpaid": ${ month10_unpaid }
#      - "month11": ${ month11 }
#      - "month11_unpaid": ${ month11_unpaid }
#      - "month12_unpaid": ${ month12_unpaid }
#      - "month12": ${ month12 }
#      - "month13": ${ month13 }
#      - "month13_unpaid": ${ month13_unpaid }
#      - "month14": ${ month14 }
#      - "month14_unpaid": ${ month14_unpaid }
#      - "month15_unpaid": ${ month15_unpaid }
#      - "month15": ${ month15 }
#      - "month16_unpaid": ${ month16_unpaid }
#      - "month16": ${ month16 }
#      - "month17": ${ month17 }
#      - "month17_unpaid": ${ month17_unpaid }
#      - "month18": ${ month18 }
#      - "month18_unpaid": ${ month18_unpaid }
#      - "month19_unpaid": ${ month19_unpaid }
#      - "month19": ${ month19 }
#      - "month20": ${ month20 }
#      - "month20_unpaid": ${ month20_unpaid }
#      - "month21": ${ month21 }
#      - "month21_unpaid": ${ month21_unpaid }
#      - "month22": ${ month22 }
#      - "month22_unpaid": ${ month22_unpaid }
#      - "month23": ${ month23 }
#      - "month23_unpaid": ${ month23_unpaid }
#      - "month24": ${ month24 }
#      - "month24_unpaid": ${ month24_unpaid }
#      - "months_total": ${ months_total }
#      - "months_unpaid_total": ${ months_unpaid_total }
---
need:
  - military_affidavit_case_name
attachment:
  name: military affidavit
  filename: military_affidavit
  variable name: military_affidavit_attachment[i]
  skip undefined: True
  pdf template file: military_affidavit.pdf
  # editable: False
  fields:
      - "docket_number": ${ docket_number }      
      - "court_department_district": ${trial_court.department == "District Court"}
      - "court_department_bmc": ${trial_court.department == "Boston Municipal Court"}
      - "court_department_housing": ${trial_court.department == "Housing Court"}
      - "court_department_juvenile": ${trial_court.department == "Juvenile Court"}
      - "court_department_land": ${trial_court.department == "Land Court"}
      - "court_department_probate_family": ${trial_court.department == "Probate and Family Court"}
      - "court_department_superior": ${trial_court.department == "Superior Court"}
      - "trial_court_division": ${ trial_court.division }
      - "petitioners": |
          % if showifdef("military_affidavit_case_name"):
          ${ military_affidavit_case_name }
          % else:
            % if user_ask_role == "plaintiff":
            % if len(other_parties):
          ${ users }
            % else:
          In the interests of ${ users }
            % endif
            % else:
          ${ other_parties }
            % endif
          % endif
      - "respondents": |
          % if user_ask_role == "defendant":
          ${ users }
          % else:
          ${ other_parties.short_list(limit=2) }
          % endif
      - "users1_name_full__1": |
          ${ users[0] }
      - "date_signed__1": ${ today() }
      - "has_serving_parties": ${ "Yes" if in_service else "Off" }
      - "serving_parties": ${ serving_parties_text }
      - "has_not_serving_parties": ${ "Yes" if not_service else "Off" }
      - "not_serving_parties": ${ not_serving_parties_text }
      - "has_concluded_service_parties": ${ "Yes" if past_service_checkbox else "Off" }
      - "concluded_service_parties_date": |
          ${ comma_and_list([f"{party.name_full()}: {party.service_ended_date}" for party in other_parties if party.military_status == "past"]) }
      - "has_unsure_serving_parties": ${ "Yes" if unable_service else "Off" }
      - "unsure_serving_parties": ${ unsure_serving_parties_text }
      - "has_used_scra_site": ${ has_used_scra_site }
      - "used_scra_site_facts": |
          % if has_used_scra_site:
          ${ used_scra_site_facts }
          % endif
      - "has_not_used_scra_site": ${not has_used_scra_site}
      - "not_used_scra_site_facts": |
          % if not has_used_scra_site:
          ${not_used_scra_site_facts }
          % endif
      - "users1_signature": |
          ${ users[0].signature_if_final(i) }
      - "date_signed__2": ${ today() }
      - "users1_name_full__2": ${users[0]}
      - "users1_address_on_one_line": ${users[0].address.on_one_line()}
      - "users1_phone": ${users[0].phone_numbers() }
      - "user_bbo": ${bbo}
      - "users1_email": ${users[0].email}

---
code: |
  military_affidavit_bundle.enabled = True
---
id: download military_affidavit
event: military_affidavit_download
question: |
  All done
subquestion: |
  Thank you ${users}. Your form is ready to download and deliver.
  
  View, download and send your form below. Click the "Edit answers" button to fix any mistakes.

  ${ action_button_html(url_action('review_military_affidavit'), label='Edit answers', color='info') }
  
  
  ${ al_user_bundle.download_list_html() }
  

  ${ al_user_bundle.send_button_html(show_editable_checkbox=False) }

progress: 100